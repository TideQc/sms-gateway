// ==========================================
// MAIN APPLICATION CLASS - cpaSmsApp
// ==========================================

class cpaSmsApp {
    constructor(containerId) {
        this.containerId = containerId;
        this.container = document.querySelector(containerId);
        
        if (!this.container) {
            throw new Error(`Container ${containerId} not found`);
        }

        // State management
        this.state = {
            user: null,
            authToken: localStorage.getItem('authToken'),
            isLoggedIn: false,
            selectedParticipants: {},
            allParticipants: [],
            smsQuickReplyCallbacks: {},
            dataTable: null,
            socket: null,
            filters: {
                parc: [],
                type: [],
                coach: []
            }
        };

        // Sub-modules
        this.login = {};
        this.ui = {};
        this.api = {};
        this.sms = {};
        this.participants = {};
        this.filters = {};
    }

    /**
     * Initialize the application
     */
    async init() {
        console.log('üöÄ Initializing cpaSmsApp...');

        // Initialize API module
        this._initApi();

        // Initialize UI module
        this._initUI();

        // Initialize Login module
        this._initLogin();

        // Initialize SMS module
        this._initSMS();

        // Initialize Participants module
        this._initParticipants();

        // Check if user is already logged in
        if (this.state.authToken) {
            try {
                await this._verifyToken();
            } catch (err) {
                this._logout();
            }
        } else {
            this._showLogin();
        }
    }

    /**
     * Initialize API module
     */
    _initApi() {
        this.api = {
            baseUrl: 'http://smscpasocket.mike.is-very-nice.org',
            
            /**
             * Make API call
             */
            call: async (endpoint, options = {}) => {
                const url = `${this.api.baseUrl}${endpoint}`;
                const headers = {
                    'Content-Type': 'application/json',
                    ...options.headers
                };

                if (this.state.authToken) {
                    headers['Authorization'] = `Bearer ${this.state.authToken}`;
                }

                try {
                    const response = await fetch(url, {
                        method: options.method || 'GET',
                        headers,
                        body: options.body ? JSON.stringify(options.body) : undefined
                    });

                    const data = await response.json();

                    if (!response.ok) {
                        throw new Error(data.error || 'API Error');
                    }

                    return data;
                } catch (err) {
                    console.error('API Error:', err);
                    throw err;
                }
            },

            /**
             * Login endpoint
             */
            login: async (username, password) => {
                return await this.api.call('/login', {
                    method: 'POST',
                    body: { username, password }
                });
            },

            /**
             * Verify token
             */
            verifyToken: async () => {
                return await this.api.call('/verify-token');
            },

            /**
             * Get participants
             */
            getParticipants: async () => {
                return await this.api.call('/participants');
            },

            /**
             * Get unread SMS
             */
            getUnreadSMS: async () => {
                return await this.api.call('/unread-sms');
            },

            /**
             * Get sent messages archive
             */
            getArchive: async () => {
                return await this.api.call('/sent-messages-archive');
            },

            /**
             * Send bulk SMS
             */
            sendBulkSMS: async (message, data) => {
                return await this.api.call('/send-bulk', {
                    method: 'POST',
                    body: { message, ...data }
                });
            },

            /**
             * Mark SMS as read
             */
            markSMSRead: async (smsId) => {
                return await this.api.call(`/mark-sms-read/${smsId}`, {
                    method: 'POST'
                });
            },

            /**
             * Mark conversation as read
             */
            markConversationRead: async (contactKey) => {
                return await this.api.call('/mark-conversation-read', {
                    method: 'POST',
                    body: { contactKey }
                });
            },

            /**
             * Import Excel file
             */
            importExcel: async (file) => {
                const formData = new FormData();
                formData.append('file', file);

                const response = await fetch(`${this.api.baseUrl}/api/participants/import-excel`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${this.state.authToken}`
                    },
                    body: formData
                });

                return await response.json();
            },

            /**
             * Check Pixel status
             */
            checkPixelStatus: async () => {
                return await this.api.call('/pixel-status');
            }
        };
    }

    /**
     * Initialize UI module
     */
    _initUI() {
        this.ui = {
            /**
             * Render login container
             */
            renderLogin: () => {
                const html = `
                    <div id="loginContainer" class="login-container">
                        <div class="card login-card">
                            <div class="card-body p-4">
                                <div class="login-header">
                                    <img src="images/logo.svg" alt="Logo">
                                    <h1>üîê Connexion</h1>
                                    <p>SMS Gateway - Cardio Plein Air</p>
                                </div>
                                
                                <form class="login-form" id="loginForm">
                                    <div class="mb-3">
                                        <label class="form-label" for="loginUsername">Nom d'utilisateur</label>
                                        <input type="text" id="loginUsername" name="loginUsername" class="form-control" placeholder="Entrez votre username" required>
                                    </div>
                                    
                                    <div class="mb-3">
                                        <label class="form-label" for="loginPassword">Mot de passe</label>
                                        <input type="password" id="loginPassword" name="loginPassword" class="form-control" placeholder="Entrez votre mot de passe" required>
                                    </div>
                                    
                                    <button type="submit" class="btn btn-login w-100">Connexion</button>
                                    
                                    <div class="login-error" id="loginError"></div>
                                    <div class="login-loading" id="loginLoading">‚è≥ Connexion en cours...</div>
                                </form>
                            </div>
                        </div>
                    </div>
                `;
                this.container.innerHTML = html;
                return document.querySelector('#loginForm');
            },

            /**
             * Render main app
             */
            renderApp: () => {
                const html = `
                    <div id="mainApp" style="height: 100%; display: flex; flex-direction: column;">
                        <div class="app-header">
                            <div class="logo-section">
                                <img src="images/logo.svg" alt="Logo">
                                <h2>üöÄ SMS Gateway</h2>
                            </div>
                            <div class="menu-section">
                                <div class="burger-menu">
                                    <button class="burger-icon" id="burgerToggle">
                                        <span></span>
                                        <span></span>
                                        <span></span>
                                    </button>
                                    <div class="burger-dropdown" id="burgerDropdown">
                                        <div id="pixelStatusContainer" class="burger-dropdown-item">
                                            <div id="pixelStatusDot" style="width: 8px; height: 8px; border-radius: 50%; background-color: #888; transition: all 0.3s ease; margin-right: 8px;"></div>
                                            <span id="pixelStatusText" style="color: #888; font-size: 0.85rem;">V√©rification...</span>
                                        </div>
                                        <div class="burger-dropdown-item">
                                            <span class="user-info">Connect√© : <strong id="loggedUsername"></strong></span>
                                        </div>
                                        <div class="burger-dropdown-item">
                                            <button id="btnLogout" class="btn btn-logout btn-sm">D√©connexion</button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="container-fluid" style="height: calc(100vh - 64px); display: flex; flex-direction: column; padding: 0;">
                            <div class="col-12" id="tabsContainer" style="flex: 1; display: flex; flex-direction: column; overflow: hidden;">
                                <ul class="nav nav-tabs mb-3" id="sendTab">
                                    <li class="nav-item"><button class="nav-link active" id="mass-tab" data-bs-toggle="tab" data-bs-target="#mass-panel">Saisie de masse</button></li>
                                    <li class="nav-item"><button class="nav-link" id="sms-tab" data-bs-toggle="tab" data-bs-target="#sms-panel">SMS <span id="unreadBadge" class="badge bg-danger ms-2" style="display: none;">0</span></button></li>
                                </ul>
                                <div class="tab-content">
                                    <div class="tab-pane fade show active" id="mass-panel">
                                        <ul class="nav nav-tabs nav-tabs-sm mb-3">
                                            <li class="nav-item"><button class="nav-link active" id="db-tab" data-bs-toggle="tab" data-bs-target="#db-panel">Base de donn√©es</button></li>
                                            <li class="nav-item"><button class="nav-link" id="manual-tab" data-bs-toggle="tab" data-bs-target="#manual-panel">Saisie Manuelle</button></li>
                                        </ul>
                                        <div class="tab-content">
                                            <div class="tab-pane fade show active" id="db-panel"></div>
                                            <div class="tab-pane fade" id="manual-panel"></div>
                                        </div>
                                    </div>
                                    <div class="tab-pane fade" id="sms-panel"></div>
                                </div>
                            </div>
                        </div>

                        <!-- MODALS -->
                        <div id="modalsContainer"></div>
                        
                        <!-- FLOATING BUTTON -->
                        <div id="composeAction" class="position-fixed bottom-0 end-0 m-4 d-none">
                            <button id="btnCompose" class="btn btn-primary btn-lg shadow-lg" data-bs-toggle="modal" data-bs-target="#composeModal">
                                ‚úâÔ∏è R√©diger un SMS (<span id="selectedCount">0</span>)
                            </button>
                        </div>
                    </div>
                `;
                this.container.innerHTML = html;
            },

            showLoader: (message = 'Chargement...') => {
                const loader = document.createElement('div');
                loader.id = 'appLoader';
                loader.style.cssText = `
                    position: fixed;
                    top: 0;
                    left: 0;
                    right: 0;
                    bottom: 0;
                    background: rgba(0, 0, 0, 0.8);
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    z-index: 9999;
                `;
                loader.innerHTML = `
                    <div style="text-align: center; color: #31a651;">
                        <div class="spinner-border mb-3" role="status"></div>
                        <p>${message}</p>
                    </div>
                `;
                document.body.appendChild(loader);
            },

            hideLoader: () => {
                const loader = document.getElementById('appLoader');
                if (loader) loader.remove();
            }
        };
    }

    /**
     * Initialize Login module
     */
    _initLogin() {
        this.login = {
            handleSubmit: async (username, password) => {
                try {
                    const response = await this.api.login(username, password);
                    
                    if (response.success) {
                        this.state.authToken = response.token;
                        this.state.user = response.username;
                        localStorage.setItem('authToken', this.state.authToken);
                        localStorage.setItem('username', response.username);
                        
                        this._showMainApp();
                        await this._initializeApp();
                    } else {
                        throw new Error(response.error || 'Erreur de connexion');
                    }
                } catch (err) {
                    console.error('Login error:', err);
                    throw err;
                }
            }
        };
    }

    /**
     * Initialize SMS module
     */
    _initSMS() {
        this.sms = {
            /**
             * Load received SMS
             */
            loadReceived: async () => {
                try {
                    const data = await this.api.getUnreadSMS();
                    // Render SMS list...
                    return data;
                } catch (err) {
                    console.error('Error loading received SMS:', err);
                    throw err;
                }
            },

            /**
             * Load archive
             */
            loadArchive: async () => {
                try {
                    const data = await this.api.getArchive();
                    // Render archive...
                    return data;
                } catch (err) {
                    console.error('Error loading archive:', err);
                    throw err;
                }
            },

            /**
             * Send quick reply
             */
            sendQuickReply: async (message, phone) => {
                // Implementation for quick SMS reply
            }
        };
    }

    /**
     * Initialize Participants module
     */
    _initParticipants() {
        this.participants = {
            /**
             * Load participants
             */
            load: async () => {
                try {
                    const data = await this.api.getParticipants();
                    this.state.allParticipants = data;
                    // Render participants table...
                    return data;
                } catch (err) {
                    console.error('Error loading participants:', err);
                    throw err;
                }
            },

            /**
             * Select participant
             */
            select: (participantId, name, phone) => {
                this.state.selectedParticipants[participantId] = { name, phone };
                this._updateParticipantsTags();
            },

            /**
             * Deselect participant
             */
            deselect: (participantId) => {
                delete this.state.selectedParticipants[participantId];
                this._updateParticipantsTags();
            },

            /**
             * Get selected count
             */
            getSelectedCount: () => {
                return Object.keys(this.state.selectedParticipants).length;
            }
        };
    }

    /**
     * Verify token
     */
    async _verifyToken() {
        try {
            const response = await this.api.verifyToken();
            
            if (response.success) {
                this.state.isLoggedIn = true;
                this.state.user = localStorage.getItem('username');
                this._showMainApp();
                await this._initializeApp();
            } else {
                throw new Error('Token invalid');
            }
        } catch (err) {
            console.error('Token verification failed:', err);
            throw err;
        }
    }

    /**
     * Show login screen
     */
    _showLogin() {
        const loginForm = this.ui.renderLogin();
        
        loginForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const username = document.querySelector('#loginUsername').value;
            const password = document.querySelector('#loginPassword').value;
            const errorEl = document.querySelector('#loginError');
            const loadingEl = document.querySelector('#loginLoading');
            
            errorEl.textContent = '';
            loadingEl.style.display = 'block';
            
            try {
                await this.login.handleSubmit(username, password);
            } catch (err) {
                errorEl.textContent = err.message || 'Identifiants invalides';
            } finally {
                loadingEl.style.display = 'none';
            }
        });
    }

    /**
     * Show main app
     */
    _showMainApp() {
        this.ui.renderApp();
        
        // Setup burger menu
        this._setupBurgerMenu();
        
        // Load user info
        document.querySelector('#loggedUsername').textContent = this.state.user;
        
        // Setup logout
        document.querySelector('#btnLogout').addEventListener('click', () => {
            if (confirm('√ätes-vous s√ªr de vouloir vous d√©connecter ?')) {
                this._logout();
            }
        });
    }

    /**
     * Initialize main app features
     */
    async _initializeApp() {
        try {
            // Check Pixel status
            await this._checkPixelStatus();
            setInterval(() => this._checkPixelStatus(), 30000);
            
            // Load participants
            await this.participants.load();
            
            // Load SMS
            await this.sms.loadReceived();
            await this.sms.loadArchive();
            
            // Initialize WebSocket
            this._initializeWebSocket();
            
        } catch (err) {
            console.error('Error initializing app:', err);
            showNotification('Erreur lors de l\'initialisation', 'error');
        }
    }

    /**
     * Setup burger menu
     */
    _setupBurgerMenu() {
        const toggle = document.querySelector('#burgerToggle');
        const dropdown = document.querySelector('#burgerDropdown');
        
        if (toggle && dropdown) {
            toggle.addEventListener('click', (e) => {
                e.stopPropagation();
                dropdown.classList.toggle('show');
                toggle.classList.toggle('active');
            });
            
            document.addEventListener('click', (e) => {
                if (!e.target.closest('.burger-menu')) {
                    dropdown.classList.remove('show');
                    toggle.classList.remove('active');
                }
            });
        }
    }

    /**
     * Check Pixel status
     */
    async _checkPixelStatus() {
        try {
            const response = await this.api.checkPixelStatus();
            const dot = document.querySelector('#pixelStatusDot');
            const text = document.querySelector('#pixelStatusText');
            
            if (dot && text) {
                if (response.connected) {
                    dot.className = 'connected';
                    text.className = 'connected';
                    text.textContent = 'T√©l√©phone: Pixel 2 Connect√©';
                } else {
                    dot.className = 'disconnected';
                    text.className = 'disconnected';
                    text.textContent = 'T√©l√©phone: Pixel 2 D√©connect√©';
                }
            }
        } catch (err) {
            const dot = document.querySelector('#pixelStatusDot');
            const text = document.querySelector('#pixelStatusText');
            if (dot && text) {
                dot.className = 'disconnected';
                text.className = 'disconnected';
                text.textContent = 'Erreur de connexion';
            }
        }
    }

    /**
     * Initialize WebSocket
     */
    _initializeWebSocket() {
        this.state.socket = io(this.api.baseUrl, {
            auth: { token: this.state.authToken }
        });

        this.state.socket.on('progress', (data) => {
            this._handleProgress(data);
        });

        this.state.socket.on('finish', () => {
            this._handleSMSComplete();
        });

        this.state.socket.on('new-sms', (data) => {
            this._handleNewSMS(data);
        });

        this.state.socket.on('sms-sent', (data) => {
            this._handleSMSSent(data);
        });
    }

    /**
     * Update participants tags
     */
    _updateParticipantsTags() {
        // Implementation for updating participant tags UI
    }

    /**
     * Handle progress event
     */
    _handleProgress(data) {
        // Implementation
    }

    /**
     * Handle SMS completion
     */
    _handleSMSComplete() {
        // Implementation
    }

    /**
     * Handle new SMS
     */
    _handleNewSMS(data) {
        // Implementation
    }

    /**
     * Handle SMS sent
     */
    _handleSMSSent(data) {
        // Implementation
    }

    /**
     * Logout
     */
    _logout() {
        localStorage.removeItem('authToken');
        localStorage.removeItem('username');
        this.state.authToken = null;
        this.state.user = null;
        this.state.isLoggedIn = false;
        
        if (this.state.socket) {
            this.state.socket.disconnect();
        }
        
        location.reload();
    }
}

// Export class
if (typeof module !== 'undefined' && module.exports) {
    module.exports = cpaSmsApp;
}
